{
  "meta": {
    "template_version": "1.0.0",
    "use_case": "MT103_TO_PACS008",
    "source": { "standard": "SWIFT_MT", "message_type": "MT103", "variant": "FIN" },
    "target": { "standard": "ISO20022", "message": "pacs.008", "schema_id": "pacs.008.001.13" },
    "created_by": "aegis",
    "created_at": "2025-10-21T00:00:00Z"
  },
  "namespaces": {
    "mx": "urn:iso:std:iso:20022:tech:xsd:pacs.008.001.13"
  },

  "defaults": {
    "GrpHdr/MsgId": { "value": "$context.request_id" },
    "GrpHdr/CreDtTm": { "value": "$now" },
    "GrpHdr/NbOfTxs": { "value": "1" },
    "GrpHdr/SttlmInf/SttlmMtd": { "value": "CLRG" }
  },

  "blocks": [
    {
      "id": "main_tx",
      "source_selector": "$mt",
      "target_root": "CdtTrfTxInf",
      "mappings": [
        { "source": "20", "target": "PmtId/InstrId" },
        { "source": "20", "target": "PmtId/EndToEndId" },

        {
          "source": "32A",
          "target": "IntrBkSttlmAmt",
          "transform": [
            { "fn": "regex_extract", "args": { "pattern": "^(\\d{6})([A-Z]{3})(.+)$", "group": 3 } },
            { "fn": "to_decimal" }
          ]
        },
        {
          "source": "32A",
          "target": "IntrBkSttlmAmt/@Ccy",
          "transform": { "fn": "regex_extract", "args": { "pattern": "^(\\d{6})([A-Z]{3})(.+)$", "group": 2 } }
        },
        {
          "source": "32A",
          "target": "IntrBkSttlmDt",
          "transform": [
            { "fn": "regex_extract", "args": { "pattern": "^(\\d{6})([A-Z]{3})(.+)$", "group": 1 } },
            { "fn": "date_parse", "args": { "format": "%y%m%d" } }
          ]
        },

        { "target": "ChrgBr", "value": "SHAR" },
        {
          "when_any": [ { "exists": "52A" }, { "exists": "53A" }, { "exists": "57A" } ],
          "switch": [
            {
              "if": { "exists": "52A" },
              "mappings": [
                { "source": "52A", "target": "InstgAgt/FinInstnId/BICFI",
                  "transform": { "fn": "regex_extract", "args": { "pattern": "^([A-Za-z0-9]{8,11})", "group": 1 } } }
              ]
            },
            {
              "if": { "exists": "53A" },
              "mappings": [
                { "source": "53A", "target": "InstgAgt/FinInstnId/BICFI",
                  "transform": { "fn": "regex_extract", "args": { "pattern": "^([A-Za-z0-9]{8,11})", "group": 1 } } }
              ]
            },
            {
              "if": { "exists": "57A" },
              "mappings": [
                { "source": "57A", "target": "InstgAgt/FinInstnId/BICFI",
                  "transform": { "fn": "regex_extract", "args": { "pattern": "^([A-Za-z0-9]{8,11})", "group": 1 } } }
              ]
            }
          ],
            "default": [
              { "target": "InstgAgt/FinInstnId/Othr/Id", "value": "NOTPROVIDED" }
            ]
        },


        {
          "when_any": [ { "exists": "50A" }, { "exists": "50F" }, { "exists": "50K" } ],
          "switch": [
            {
              "if": { "exists": "50A" },
              "mappings": [
                { "source": "50A", "target": "Dbtr/Nm",
                  "transform": { "fn": "regex_extract", "args": { "pattern": "^([A-Za-z0-9]{8,11})", "group": 1 } } }
              ]
            },
            {
              "if": { "exists": "50F" },
              "mappings": [
                { "source": "50F", "target": "Dbtr/Nm",
                  "transform": { "fn": "regex_extract", "args": { "pattern": "^(?:/.*\\n)?([^\\n]+)", "group": 1 } } },
                { "source": "50F", "target": "Dbtr/PstlAdr/AdrLine",
                  "transform": [
                    { "fn": "regex_extract", "args": { "pattern": "^(?:/.*\\n)?[^\\n]+\\n([\\s\\S]+)$", "group": 1 } },
                    { "fn": "lines" }
                  ] },
                { "source": "50F", "target": "DbtrAcct/Id/IBAN",
                  "transform": [
                    { "fn": "regex_extract", "args": { "pattern": "^/([^\\n]+)", "group": 1 } },
                    { "fn": "iban_normalize" }
                  ],
                  "on_fail": "DbtrAcct/Id/Othr/Id" }
              ]
            },
            {
              "if": { "exists": "50K" },
              "mappings": [
                { "source": "50K", "target": "Dbtr/Nm",
                  "transform": { "fn": "regex_extract", "args": { "pattern": "^(?:/.*\\n)?([^\\n]+)", "group": 1 } } },
                { "source": "50K", "target": "Dbtr/PstlAdr/AdrLine",
                  "transform": [
                    { "fn": "regex_extract", "args": { "pattern": "^(?:/.*\\n)?[^\\n]+\\n([\\s\\S]+)$", "group": 1 } },
                    { "fn": "lines" }
                  ] },
                { "source": "50K", "target": "DbtrAcct/Id/Othr/Id",
                  "transform": [
                    { "fn": "regex_extract", "args": { "pattern": "^/([^\\n]+)", "group": 1 } },
                    { "fn": "truncate", "args": { "max": 34 } }
                  ] }
              ]
            }
          ]
        },
        {
          "when_any": [ { "exists": "52A" }, { "exists": "53A" }, { "exists": "57A" } ],
          "switch": [
            {
              "if": { "exists": "52A" },
              "mappings": [
                { "source": "52A", "target": "DbtrAgt/FinInstnId/BICFI",
                  "transform": { "fn": "regex_extract", "args": { "pattern": "^([A-Za-z0-9]{8,11})", "group": 1 } } }
              ]
            },
            {
              "if": { "exists": "53A" },
              "mappings": [
                { "source": "53A", "target": "DbtrAgt/FinInstnId/BICFI",
                  "transform": { "fn": "regex_extract", "args": { "pattern": "^([A-Za-z0-9]{8,11})", "group": 1 } } }
              ]
            },
            {
              "if": { "exists": "57A" },
              "mappings": [
                { "source": "57A", "target": "DbtrAgt/FinInstnId/BICFI",
                  "transform": { "fn": "regex_extract", "args": { "pattern": "^([A-Za-z0-9]{8,11})", "group": 1 } } }
              ]
            }
          ],
            "default": [
              { "target": "DbtrAgt/FinInstnId/Othr/Id", "value": "NOTPROVIDED" }
            ]
        },

        { "source": "57A", "target": "CdtrAgt/FinInstnId/BICFI",
          "transform": { "fn": "regex_extract", "args": { "pattern": "^([A-Za-z0-9]{8,11})", "group": 1 } } },

        { "source": "59", "target": "Cdtr/Nm",
          "transform": { "fn": "regex_extract", "args": { "pattern": "^(?:/.*\\n)?([^\\n]+)", "group": 1 } } },
        { "source": "59", "target": "Cdtr/PstlAdr/AdrLine",
          "transform": [
            { "fn": "regex_extract", "args": { "pattern": "^(?:/.*\\n)?[^\\n]+\\n([\\s\\S]+)$", "group": 1 } },
            { "fn": "lines" }
          ] },
        { "source": "59", "target": "CdtrAcct/Id/IBAN",
          "transform": [
            { "fn": "regex_extract", "args": { "pattern": "^/([^\\n]+)", "group": 1 } },
            { "fn": "iban_normalize" }
          ],
          "on_fail": "CdtrAcct/Id/Othr/Id" },

        { "source": "70", "target": "RmtInf/Ustrd",
          "transform": [ { "fn": "truncate", "args": { "max": 140 } } ] }
      ]
    }
  ],

  "validations": [
    { "path": "GrpHdr/MsgId", "required": true },
    { "path": "CdtTrfTxInf/PmtId/InstrId", "required": true },
    { "path": "CdtTrfTxInf/IntrBkSttlmAmt/@Ccy", "required": true },
    { "path": "CdtTrfTxInf/IntrBkSttlmDt", "required": true },
    { "path": "CdtTrfTxInf/Cdtr/Nm", "required": true }
  ],

  "transforms_catalog": [
    "to_decimal",
    "date_parse(format)",
    "iban_normalize",
    "lines",
    "truncate(max)",
    "upper",
    "regex_extract(pattern,group)"
  ],

  "error_policies": {
    "on_missing_required": "fail",
    "on_transform_error": "warn_and_copy_raw",
    "on_unknown_tag": "ignore"
  }
}