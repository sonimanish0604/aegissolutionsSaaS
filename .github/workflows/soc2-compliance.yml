name: SOC2 Compliance Checks

on:
  pull_request:
  push:
    branches:
      - main
      - develop

jobs:
  compliance:
    name: Run SOC2 compliance suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -r services/aegis-iso20022-api/requirements.txt

      - name: Install security tooling
        run: |
          # gitleaks
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks
          rm gitleaks.tar.gz

          # semgrep
          pip install semgrep

          # syft
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin

          # grype
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo sh -s -- -b /usr/local/bin

      - name: Run SOC2 compliance checks
        working-directory: services/aegis-iso20022-api
        run: |
          mkdir -p $GITHUB_WORKSPACE/artifacts
          python scripts/soc2_compliance.py --output $GITHUB_WORKSPACE/artifacts/soc2_report.json

      - name: Upload report artifact
        uses: actions/upload-artifact@v5
        with:
          name: soc2-report
          path: artifacts/soc2_report.json

      - name: Publish compliance report to evidence repository
        if: github.event_name == 'pull_request' || github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.COMPLIANCE_BOT_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "COMPLIANCE_BOT_TOKEN secret is not configured; skipping publish." && exit 0
          fi

          REPORT_REPO="https://github.com/sonimanish0604/aegis-compliance-evidence.git"
          WORKDIR=$(mktemp -d)
          git clone --depth=1 https://${GH_TOKEN}@github.com/sonimanish0604/aegis-compliance-evidence.git "$WORKDIR"

          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            IDENTIFIER="PR${{ github.event.number }}"
          else
            IDENTIFIER="${GITHUB_REF##*/}-${GITHUB_SHA:0:7}"
          fi
          DEST_DIR="$WORKDIR/reports/${TIMESTAMP:0:4}/${TIMESTAMP:4:2}"
          mkdir -p "$DEST_DIR"
          DEST_PATH="$DEST_DIR/SOC2_${IDENTIFIER}_${TIMESTAMP}.json"
          cp "$GITHUB_WORKSPACE/artifacts/soc2_report.json" "$DEST_PATH"

          cd "$WORKDIR"
          git config user.name "aegis-compliance-bot"
          git config user.email "compliance-bot@aegis.local"
          git add "$DEST_PATH"
          git commit -m "Add SOC2 report for ${IDENTIFIER} (${TIMESTAMP})"
          git push origin HEAD
