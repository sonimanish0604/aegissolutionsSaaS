name: Docker Compose Testing

on:
  push:
    branches: [testing]

jobs:
  compose-testing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Build image
        run: docker compose -f docker-compose.dev.yml build

      - name: Start stack
        run: docker compose -f docker-compose.dev.yml -f docker-compose.testing.yml up -d

      - name: Wait for translator
        shell: bash
        run: |
          end=$((SECONDS+180))
          until curl -fsS http://localhost:8080/ > /dev/null; do
            if [ $SECONDS -ge $end ]; then
              echo "Translator service did not become ready"
              docker compose -f docker-compose.dev.yml -f docker-compose.testing.yml logs translator || true
              exit 1
            fi
            echo "Waiting for translator..."
            sleep 5
          done

      - name: Wait for prevalidator
        shell: bash
        run: |
          end=$((SECONDS+180))
          until curl -fsS http://localhost:8081/ > /dev/null; do
            if [ $SECONDS -ge $end ]; then
              echo "Prevalidator service did not become ready"
              docker compose -f docker-compose.dev.yml -f docker-compose.testing.yml logs prevalidator || true
              exit 1
            fi
            echo "Waiting for prevalidator..."
            sleep 5
          done

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r services/aegis-iso20022-api/requirements.txt

      - name: Run audit smoke test
        env:
          TRANSLATOR_URL: http://localhost:8080
          PREVALIDATOR_URL: http://localhost:8081
          S3_ENDPOINT_URL: http://localhost:4566
          AUDIT_S3_BUCKET: audit-manifests
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_REGION: us-east-1
        run: python tests/system/audit_smoke.py

      - name: Docker logs
        if: always()
        run: docker compose -f docker-compose.dev.yml -f docker-compose.testing.yml logs > docker-compose-testing.log

      - name: Tear down
        if: always()
        run: docker compose -f docker-compose.dev.yml -f docker-compose.testing.yml down -v --remove-orphans

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: docker-compose-testing-logs
          path: docker-compose-testing.log

      - name: Publish evidence
        if: always()
        env:
          GH_TOKEN: ${{ secrets.COMPLIANCE_BOT_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "COMPLIANCE_BOT_TOKEN not set; skipping evidence publish."
            exit 0
          fi

          REPORT_REPO="https://github.com/sonimanish0604/aegis-compliance-evidence.git"
          WORKDIR=$(mktemp -d)
          git clone --depth=1 https://${GH_TOKEN}@github.com/sonimanish0604/aegis-compliance-evidence.git "$WORKDIR"

          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          IDENTIFIER="testing-${GITHUB_SHA:0:7}"

          DEST_DIR="$WORKDIR/smoke/${TIMESTAMP:0:4}/${TIMESTAMP:4:2}"
          mkdir -p "$DEST_DIR"

          LOG_DEST="$DEST_DIR/docker_testing_${IDENTIFIER}_${TIMESTAMP}.log"
          cp docker-compose-testing.log "$LOG_DEST"

          META_PATH="$DEST_DIR/docker_testing_${IDENTIFIER}_${TIMESTAMP}.json"
          cat <<JSON > "$META_PATH"
          {
            "identifier": "${IDENTIFIER}",
            "timestamp": "${TIMESTAMP}",
            "source_workflow": "${GITHUB_WORKFLOW}",
            "run_url": "https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          }
          JSON

          cd "$WORKDIR"
          git config user.name "aegis-compliance-bot"
          git config user.email "compliance-bot@aegis.local"
          git add "$LOG_DEST" "$META_PATH"
          git commit -m "Add Docker testing evidence ${IDENTIFIER} (${TIMESTAMP})"
          git push origin HEAD
