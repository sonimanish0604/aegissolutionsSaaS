name: Docker Compose Staging

on:
  push:
    branches: [staging]

jobs:
  staging-deploy:
    runs-on: ubuntu-latest
    env:
      KAFKA_BOOTSTRAP_SERVERS: ${{ secrets.STAGING_KAFKA_BOOTSTRAP }}
      AUDIT_S3_BUCKET: ${{ secrets.STAGING_AUDIT_BUCKET }}
      AWS_REGION: us-east-1
    steps:
      - uses: actions/checkout@v5

      - name: Start staging stack
        run: docker compose -f docker-compose.dev.yml -f docker-compose.staging.yml up -d --build

      - name: Wait for translator
        shell: bash
        run: |
          end=$((SECONDS+180))
          until curl -fsS http://localhost:8080/ > /dev/null; do
            if [ $SECONDS -ge $end ]; then
              echo "Translator service did not become ready"
              docker compose -f docker-compose.dev.yml -f docker-compose.staging.yml logs translator || true
              exit 1
            fi
            echo "Waiting for translator..."
            sleep 5
          done

      - name: Wait for prevalidator
        shell: bash
        run: |
          end=$((SECONDS+180))
          until curl -fsS http://localhost:8081/ > /dev/null; do
            if [ $SECONDS -ge $end ]; then
              echo "Prevalidator service did not become ready"
              docker compose -f docker-compose.dev.yml -f docker-compose.staging.yml logs prevalidator || true
              exit 1
            fi
            echo "Waiting for prevalidator..."
            sleep 5
          done

      - name: Smoke audit test
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - run: |
          python -m pip install --upgrade pip
          pip install -r services/aegis-iso20022-api/requirements.txt
      - run: python tests/system/audit_smoke.py
        env:
          TRANSLATOR_URL: http://localhost:8080
          PREVALIDATOR_URL: http://localhost:8081
          S3_ENDPOINT_URL: ${{ secrets.STAGING_S3_ENDPOINT }}
          AUDIT_S3_BUCKET: ${{ secrets.STAGING_AUDIT_BUCKET }}
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: ${{ secrets.STAGING_AWS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.STAGING_AWS_SECRET }}

      - name: Publish staging evidence
        if: always()
        env:
          GH_TOKEN: ${{ secrets.COMPLIANCE_BOT_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "COMPLIANCE_BOT_TOKEN missing; skipping evidence publish." && exit 0
          fi
          REPORT_REPO="https://github.com/sonimanish0604/aegis-compliance-evidence.git"
          WORKDIR=$(mktemp -d)
          git clone --depth=1 https://${GH_TOKEN}@github.com/sonimanish0604/aegis-compliance-evidence.git "$WORKDIR"
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          IDENTIFIER="staging-${GITHUB_SHA:0:7}"
          DEST_DIR="$WORKDIR/smoke/${TIMESTAMP:0:4}/${TIMESTAMP:4:2}"
          mkdir -p "$DEST_DIR"
          LOG_DEST="$DEST_DIR/docker_staging_${IDENTIFIER}_${TIMESTAMP}.log"
          docker compose -f docker-compose.dev.yml -f docker-compose.staging.yml logs > "$LOG_DEST"
          META_PATH="$DEST_DIR/docker_staging_${IDENTIFIER}_${TIMESTAMP}.json"
          cat <<JSON > "$META_PATH"
          {
            "identifier": "${IDENTIFIER}",
            "timestamp": "${TIMESTAMP}",
            "source_workflow": "${GITHUB_WORKFLOW}",
            "run_url": "https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          }
          JSON
          cd "$WORKDIR"
          git config user.name "aegis-compliance-bot"
          git config user.email "compliance-bot@aegis.local"
          git add "$LOG_DEST" "$META_PATH"
          git commit -m "Add staging docker evidence ${IDENTIFIER} (${TIMESTAMP})"
          git push origin HEAD
