name: Docker Compose CI

on:
  pull_request:
    branches: [develop]
  push:
    branches: [develop]

jobs:
  compose-smoke-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Build and start stack
        run: docker compose -f docker-compose.dev.yml up -d --build

      - name: Wait for translator
        uses: jtalk/url-health-check-action@v4
        with:
          url: http://localhost:8080/
          retry-delay: 5s
          max-attempts: 30

      - name: Wait for prevalidator
        uses: jtalk/url-health-check-action@v4
        with:
          url: http://localhost:8081/
          retry-delay: 5s
          max-attempts: 30

      - name: Install smoke test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r services/aegis-iso20022-api/requirements.txt

      - name: Run audit smoke tests
        env:
          TRANSLATOR_URL: http://localhost:8080
          PREVALIDATOR_URL: http://localhost:8081
          S3_ENDPOINT_URL: http://localhost:4566
          AUDIT_S3_BUCKET: audit-manifests
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_REGION: us-east-1
        run: python tests/system/audit_smoke.py

      - name: Docker logs
        if: always()
        run: docker compose -f docker-compose.dev.yml logs > docker-compose.log

      - name: Tear down
        if: always()
        run: docker compose -f docker-compose.dev.yml down -v --remove-orphans

      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: docker-compose-logs
          path: docker-compose.log

      - name: Publish smoke evidence to compliance repo
        if: always()
        env:
          GH_TOKEN: ${{ secrets.COMPLIANCE_BOT_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "COMPLIANCE_BOT_TOKEN not set; skipping evidence publish."
            exit 0
          fi

          REPORT_REPO="https://github.com/sonimanish0604/aegis-compliance-evidence.git"
          WORKDIR=$(mktemp -d)
          git clone --depth=1 https://${GH_TOKEN}@github.com/sonimanish0604/aegis-compliance-evidence.git "$WORKDIR"

          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            IDENTIFIER="PR${{ github.event.number }}"
          else
            IDENTIFIER="${GITHUB_REF##*/}-${GITHUB_SHA:0:7}"
          fi

          DEST_DIR="$WORKDIR/smoke/${TIMESTAMP:0:4}/${TIMESTAMP:4:2}"
          mkdir -p "$DEST_DIR"

          LOG_DEST="$DEST_DIR/docker_smoke_${IDENTIFIER}_${TIMESTAMP}.log"
          cp docker-compose.log "$LOG_DEST"

          META_PATH="$DEST_DIR/docker_smoke_${IDENTIFIER}_${TIMESTAMP}.json"
          cat <<JSON > "$META_PATH"
          {
            "identifier": "${IDENTIFIER}",
            "timestamp": "${TIMESTAMP}",
            "source_workflow": "${GITHUB_WORKFLOW}",
            "run_url": "https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          }
          JSON

          cd "$WORKDIR"
          git config user.name "aegis-compliance-bot"
          git config user.email "compliance-bot@aegis.local"
          git add "$LOG_DEST" "$META_PATH"
          git commit -m "Add Docker smoke evidence for ${IDENTIFIER} (${TIMESTAMP})"
          git push origin HEAD
