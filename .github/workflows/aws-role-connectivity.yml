name: AWS Role Connectivity

on:
  push:
    branches:
      - testing
      - develop
      - staging
      - main
  pull_request:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to target (testing|staging|production)"
        required: true
        default: "testing"
        type: choice
        options:
          - testing
          - staging
          - production

jobs:
  assume-role:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      CONNECTIVITY_ROLE_PREFIX: ${{ secrets.CONNECTIVITY_ROLE_PREFIX }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Resolve role ARN
        id: target
        run: |
          account="${{ env.AWS_ACCOUNT_ID }}"
          prefix="${{ env.CONNECTIVITY_ROLE_PREFIX }}"

          role_arn() {
            local target_env="$1"
            echo "arn:aws:iam::${account}:role/${prefix}-${target_env}-connectivity"
          }

          if [[ "${{ github.event_name }}" == "push" ]]; then
            case "${{ github.ref_name }}" in
              testing|develop) env_name="testing"; role="$(role_arn testing)" ;;
              staging) env_name="staging"; role="$(role_arn staging)" ;;
              main) env_name="production"; role="$(role_arn production)" ;;
              *) echo "Unsupported branch ${{ github.ref_name }}"; exit 1 ;;
            esac
          else
            env_name="${{ github.event.inputs.environment }}"
            case "$env_name" in
              testing) role="$(role_arn testing)" ;;
              staging) role="$(role_arn staging)" ;;
              production) role="$(role_arn production)" ;;
              *) echo "Unsupported environment $env_name"; exit 1 ;;
            esac
          fi

          if [[ -z "$role" ]]; then
            echo "::error ::Resolved empty role ARN for environment."
            exit 1
          fi

          echo "role=${role}" >> "$GITHUB_OUTPUT"
          echo "display_env=${env_name}" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ steps.target.outputs.role }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Show caller identity
        run: |
          echo "Environment: ${{ steps.target.outputs.display_env }}"
          aws sts get-caller-identity

  pr-connectivity:
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'develop'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      AWS_ACCOUNT_ID: "278509814291"
      CONNECTIVITY_ROLE_PREFIX: aegis-iso20022
    strategy:
      matrix:
        include:
          - environment: testing
            expect: success
            description: "PR tokens targeting develop must assume the testing role."
          - environment: staging
            expect: failure
            description: "PR tokens must be blocked from the staging role."
          - environment: production
            expect: failure
            description: "PR tokens must be blocked from the production role."

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Resolve role ARN
        id: pr_role
        run: |
          account="${{ env.AWS_ACCOUNT_ID }}"
          prefix="${{ env.CONNECTIVITY_ROLE_PREFIX }}"
          env_name="${{ matrix.environment }}"
          echo "arn=arn:aws:iam::${account}:role/${prefix}-${env_name}-connectivity" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials
        id: pr_creds
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ steps.pr_role.outputs.arn }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Show caller identity
        if: steps.pr_creds.outcome == 'success'
        run: aws sts get-caller-identity

      - name: Validate expected outcome
        run: |
          expected="${{ matrix.expect }}"
          actual="${{ steps.pr_creds.outcome }}"
          echo "Scenario: ${{ matrix.description }}"
          echo "Expected: $expected, Actual: $actual"
          if [[ "$expected" == "success" && "$actual" != "success" ]]; then
            echo "::error ::Connectivity role should have been assumable but failed."
            exit 1
          fi
          if [[ "$expected" == "failure" && "$actual" == "success" ]]; then
            echo "::error ::Connectivity role assumed successfully when failure was expected."
            exit 1
          fi
          echo "Outcome matched expectation."
